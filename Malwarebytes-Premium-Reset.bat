:: ==================================================
::  Malwarebytes-Premium-Reset v13.0
:: ==================================================
::  Dev  - Scut1ny
::  Help - AmmarSAA & firebirdjsb
::  Link - https://github.com/Scrut1ny/Malwarebytes-Premium-Reset
::
::  Note: using this will wipe all your Malwarebytes settings
::
::  changelog for v13.0: Refactered
:: ==================================================

@echo off
title Malwarebytes-Premium-Reset ^| v13.0

:: Check if the user has administrative privileges
net session >nul 2>&1 || (
    echo Administrative privileges are required to run this script.
    timeout /t 3 >nul
    exit /b 1
)

setlocal

:: Define paths
set "regKey=HKLM\SOFTWARE\Microsoft\Cryptography"
set "machineGUIDValue=MachineGuid"
set "lastRunDateValue=LastRunDay"
set "mbamPathX86=%PROGRAMFILES(X86)%\Malwarebytes\Anti-Malware"
set "mbamPathX64=%PROGRAMFILES%\Malwarebytes\Anti-Malware"
set "mbamAssistant=malwarebytes_assistant.exe"
set "mbamUi=mbam.exe"

:: Output header
echo   Malwarebytes: Reset Premium Trial
echo   ---------------------------------

echo [+] Calculating trial timeout...

:: Get the current date in YYYY-MM-DD format
for /f "tokens=2 delims==" %%I in ('wmic os get localdatetime /value ^| find "="') do set "currentDate=%%I"
set "currentDate=%currentDate:~0,4%-%currentDate:~4,2%-%currentDate:~6,2%"

:: Get the date 15 days ago
for /f %%I in ('powershell -command "[datetime]::Now.AddDays(-15).ToString('yyyy-MM-dd')"') do set "date15DaysAgo=%%I"

:: Check if the registry key exists
reg query "%regKey%" /v "%lastRunDateValue%" >nul 2>&1
if %errorlevel% neq 0 (
    reg add "%regKey%" /v "%lastRunDateValue%" /t REG_SZ /d "%date15DaysAgo%" /f >nul
)

:: Get the value of the registry key (LastRunDate)
for /f "tokens=3" %%A in ('reg query "%regKey%" /v "%lastRunDateValue%"') do set "lastRunDate=%%A"

:: Convert dates to Julian Day Number
call :DateToJulian "%currentDate%" currentDateJulian
call :DateToJulian "%lastRunDate%" lastRunDateJulian

:: Calculate difference
set /a daysDifference=currentDateJulian-lastRunDateJulian
set "dayDiffMessage=Script have been executed %daysDifference% days ago."

:: Check if the difference is less than 13 days
if %daysDifference% lss 13 (
    Echo %dayDiffMessage% Exiting...
    timeout /t 3 >nul
    exit /b 1
)
echo %dayDiffMessage% Continuing...

:: Kill Malwarebytes processes
echo [+] Killing Malwarebytes assistant...
for %%P in ("%mbamPathX86%\%mbamAssistant%" "%mbamPathX64%\%mbamAssistant%") do (
    if exist "%%~P" (
        "%%~P" --stopservice
        echo Processes have been successfully terminated.
        goto KillService
    )
)
echo Processes failed. Malwarebytes assistant not found.
timeout /t 3 >nul
exit /b 1

:: Kill Malwarebytes processes
:KillService
echo [+] Killing Malwarebytes service...
taskkill /f /im MBAMService.exe >nul 2>&1
if %errorlevel% neq 0 (
    echo Processes succeed.
)

:: Run the reset task
echo [+] Running the reset process...
for /f %%a in ('powershell -c "[guid]::NewGuid().ToString()"') do (
    reg add "%regKey%" /v "%machineGUIDValue%" /t REG_SZ /d "%%a" /f >nul
)
echo Processes succeed.

:: Restart Malwarebytes processes
echo [+] Restarting Mbam Processes...
for %%P in ("%mbamPathX86%\%mbamAssistant%" "%mbamPathX64%\%mbamAssistant%") do (
    if exist "%%~P" (
        start "" "%%~P" >nul 2>&1
        goto End
    )
)
echo Processes failed. Malwarebytes assistant not found.
timeout /t 3 >nul
exit /b 1

:End
reg add "%regKey%" /v "%lastRunDateValue%" /t REG_SZ /d "%currentDate%" /f >nul
echo Done, thank you for using this trial resetter.

:: Open Malwarebytes for regist Premium trial
for %%P in ("%mbamPathX86%\%mbamUi%" "%mbamPathX64%\%mbamUi%") do (
    if exist "%%~P" (
        start "" "%%~P" >nul 2>&1
        goto Exit
    )
)

:Exit
timeout /t 3 >nul
endlocal
exit /b

:DateToJulian
:: Convert a date in YYYY-MM-DD format to Julian Day Number
setlocal
set "date=%~1"
for /f "tokens=1-3 delims=-" %%A in ("%date%") do (
    set "year=%%A"
    set "month=%%B"
    set "day=%%C"
)
set /a "jd=1461*(year+4800+(month-14)/12)/4 + 367*(month-2-12*((month-14)/12))/12 - 32075 + day"
endlocal & set "%~2=%jd%"
exit /b
